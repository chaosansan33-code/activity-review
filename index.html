<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¤©ä¸‹æ›¸é™¢ï¼šæ‹†è§£ï¼é‡çµ„</title>
  <style>
    :root{
      --bg:#f7f4ee;
      --panel:#ffffffcc;
      --text:#1f2430;
      --muted:#6b7280;
      --line:#e6e2d9;
      --shadow: 0 10px 30px rgba(0,0,0,.08);
      --radius: 18px;
      --accent:#ff6b9b;
      --danger:#ff4d4f;
      --warn:#f59e0b;
      --ok:#22c55e;
      --ink:#111827;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 700px at 15% 10%, #fff 0%, var(--bg) 55%, #f0ede6 100%);
      min-height:100vh;
    }
    .app{ max-width:1200px; margin:0 auto; padding:18px 14px 60px; }
    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 14px; border:1px solid var(--line); background:var(--panel);
      border-radius:var(--radius); box-shadow:var(--shadow);
      position:sticky; top:10px; z-index:30; backdrop-filter: blur(10px);
    }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.3px; }
    .brand .logo{
      width:34px; height:34px; border-radius:12px;
      background: linear-gradient(135deg, var(--accent), #ffd27a);
      box-shadow: 0 10px 25px rgba(255,107,155,.22);
    }
    .badge{
      font-size:12px; padding:4px 10px; border-radius:999px;
      border:1px solid var(--line); background:#fff; color:var(--muted);
    }
    .btn{
      border:1px solid var(--line); background:#fff; color:var(--ink);
      padding:9px 12px; border-radius:14px; cursor:pointer; font-weight:800;
      display:inline-flex; align-items:center; gap:8px;
      transition: transform .05s ease, box-shadow .2s ease, background .2s ease;
      box-shadow: 0 8px 18px rgba(0,0,0,.06);
      user-select:none;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px); box-shadow:none; }
    .btn.primary{
      border-color: transparent;
      background: linear-gradient(135deg, var(--accent), #ffd27a);
      color:#111;
    }
    .btn.ghost{ background: transparent; box-shadow:none; }
    .btn.danger{
      border-color: transparent;
      background: linear-gradient(135deg, var(--danger), #ff9aa2);
      color:#111;
    }
    .btn.small{ padding:7px 10px; border-radius:12px; font-size:13px; }
    .btn.tiny{ padding:6px 9px; border-radius:11px; font-size:12px; box-shadow:none; }

    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .grid{
      display:grid;
      grid-template-columns: 1.08fr .92fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .topbar{ position:static; }
    }
    .panel{
      border:1px solid var(--line); background:var(--panel);
      border-radius:var(--radius); box-shadow:var(--shadow);
      padding:14px; backdrop-filter: blur(10px);
    }
    .hint{ font-size:12px; color:var(--muted); line-height:1.4; }
    .hr{ height:1px; background:var(--line); margin:10px 0; }
    .input, textarea, select{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background:#fff;
      outline:none;
      font-size:14px;
    }
    textarea{ min-height:88px; resize:vertical; }
    .chip{
      padding:6px 10px; border-radius:999px;
      border:1px solid var(--line); background:#fff;
      font-size:12px; font-weight:900; color:var(--muted);
      display:inline-flex; gap:6px; align-items:center;
    }
    .chip.ok{ color:#0f5132; background:#e7f6ee; border-color:#c7ead6; }
    .chip.warn{ color:#7c4a03; background:#fff3d6; border-color:#f7e1a6; }
    .chip.danger{ color:#6b1220; background:#ffe1e1; border-color:#ffc2c2; }
    .card{
      border:1px solid var(--line);
      border-radius:22px;
      background:#fff;
      box-shadow: 0 12px 24px rgba(0,0,0,.06);
      overflow:hidden;
    }
    .card .head{
      padding:12px 14px;
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, #ffffff, #fafafa);
    }
    .card .title{
      font-weight:900;
      display:flex; align-items:center; gap:10px;
    }
    .icon{
      width:30px; height:30px; border-radius:12px;
      background: linear-gradient(135deg, rgba(255,107,155,.9), rgba(255,210,122,.9));
      display:grid; place-items:center; font-weight:900;
      box-shadow: 0 10px 18px rgba(255,107,155,.18);
    }
    .card .body{ padding:14px; }
    .bigQ{ font-size:18px; font-weight:900; line-height:1.25; }
    .sub{ font-size:13px; color:var(--muted); line-height:1.5; margin-top:6px; }
    .pill{
      font-size:12px; padding:5px 10px; border-radius:999px;
      background:#f3f4f6; border:1px solid #e5e7eb;
      color:#374151; font-weight:800; display:inline-flex; gap:6px; align-items:center;
    }
    .pill.accent{ background: rgba(255,107,155,.12); border-color: rgba(255,107,155,.25); }
    .pill.ok{ background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.25); }
    .pill.warn{ background: rgba(245,158,11,.12); border-color: rgba(245,158,11,.25); }
    .pill.danger{ background: rgba(239,68,68,.12); border-color: rgba(239,68,68,.25); }
    .two{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 680px){ .two{ grid-template-columns: 1fr; } }

    .toast{
      position:fixed; right:14px; bottom:14px;
      background:#111827; color:#fff;
      padding:10px 12px; border-radius:14px;
      box-shadow: 0 16px 30px rgba(0,0,0,.25);
      max-width: 360px; z-index:80;
      display:none;
    }

    details{
      border:1px solid var(--line);
      background:#fff;
      border-radius:18px;
      padding:10px 12px;
      box-shadow: 0 10px 18px rgba(0,0,0,.06);
    }
    summary{
      cursor:pointer;
      font-weight:900;
      list-style:none;
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
    }
    summary::-webkit-details-marker{ display:none; }

    .listItem{
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 12px;
      display:flex; justify-content:space-between; align-items:flex-start; gap:10px;
      background:#fff;
    }
    .miniIcon{
      width:28px;height:28px;border-radius:12px;
      background: linear-gradient(135deg, rgba(255,107,155,.9), rgba(255,210,122,.9));
      display:grid; place-items:center; font-weight:900;
    }
    .tagRow{ display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
    .tag{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      font-size:12px;
      font-weight:900;
      color:#374151;
      cursor:pointer;
      user-select:none;
    }
    .kbd{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:12px;
      padding:2px 6px;
      border-radius:8px;
      border:1px solid #e5e7eb;
      background:#f9fafb;
      color:#111;
    }
    .lockBanner{
      padding:10px 12px;
      border-radius:16px;
      border:1px dashed rgba(245,158,11,.5);
      background: rgba(245,158,11,.12);
      color:#7c4a03;
      font-weight:900;
      line-height:1.45;
    }
    .voteGrid{
      display:grid; grid-template-columns: 1fr auto auto; gap:8px; align-items:center;
      border:1px solid var(--line); border-radius:16px; background:#fff; padding:10px 12px;
    }

    /* ===== Stage Intro Overlay (mobile safe) ===== */
.overlay{
  position:fixed; inset:0;
  display:none;
  align-items:center; justify-content:center;
  background: rgba(17,24,39,.55);
  z-index: 120;
  padding: 12px;
  backdrop-filter: blur(6px);
}

/* ç”¨ svh/dvh é¿å…æ‰‹æ©Ÿç¶²å€åˆ—é€ æˆ vh å¤±çœŸ */
.overlay .box{
  width: min(860px, 100%);
  height: min(92svh, 720px);      /* âœ… ç›´æ¥çµ¦é«˜åº¦ä¸Šé™ */
  max-height: 92svh;
  display:flex;
  flex-direction:column;
  border-radius: 22px;
  background:#fff;
  border:1px solid rgba(255,255,255,.5);
  box-shadow: 0 20px 60px rgba(0,0,0,.25);
  overflow:hidden;
}

/* å¦‚æœç€è¦½å™¨æ”¯æ´ dvhï¼Œå°±æ›´æº– */
@supports (height: 1dvh){
  .overlay .box{
    height: min(92dvh, 720px);
    max-height: 92dvh;
  }
}

.overlay .mediaWrap{
  background:#0b1220;
  flex:1 1 auto;
  min-height:0;                 /* âœ… å…è¨±ç¸®å°é¿å…æº¢å‡º */
  display:flex;
  align-items:center;
  justify-content:center;
  padding: 8px;                 /* âœ… è®“åœ–ç‰‡ä¸æœƒè²¼é‚Š */
}

/* åœ–ç‰‡/å½±ç‰‡ï¼šå®Œæ•´é¡¯ç¤ºã€ä¸è£åˆ‡ã€ä¸è¶…å‡º */
.overlay img,
.overlay video{
  max-width: 100%;
  max-height: 100%;
  width: auto;
  height: auto;
  display:block;
  object-fit: contain;
}

/* åƒç´ åœ–æ›´éŠ³åˆ©ï¼ˆå¯ç•™ï¼‰ */
.overlay img{ image-rendering: pixelated; }

.overlay .foot{
  flex:0 0 auto;
  padding: 12px 14px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  border-top:1px solid var(--line);
  background: linear-gradient(180deg, #ffffff, #fafafa);
}

.overlay .titleLine{
  font-weight: 900;
  color: #111827;
}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div>
          å¤©ä¸‹æ›¸é™¢ï¼šæ‹†è§£ï¼é‡çµ„ <span class="badge" id="modeBadge">Lobby</span>
          <div class="hint">å–”è€¶ï¼</div>
        </div>
      </div>
      <div class="row">
        <button class="btn" id="btnExportCSV">ğŸ“¤ åŒ¯å‡ºCSV</button>
        <button class="btn ghost" id="btnReset">ğŸ§¹ é‡ç½®æœ¬å±€</button>
      </div>
    </div>

    <div class="grid">
      <div class="panel" id="mainPanel"></div>
      <div class="panel" id="sidePanel"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Stage Intro / Pig Intro Overlay -->
  <div class="overlay" id="introOverlay" aria-hidden="true">
    <div class="box">
      <div class="mediaWrap" id="introMediaWrap"></div>
      <div class="foot">
        <div>
          <div class="titleLine" id="introTitle">é–‹å§‹</div>
          <div class="hint" id="introHint">é»æ“Šç¹¼çºŒ</div>
        </div>
        <button class="btn primary" id="introContinue">ğŸ‘‰ è€¶ï¼ç¹¼çºŒ</button>
      </div>
    </div>
  </div>

<script>
/** =========================
 *  ä½ è¦æ’å…¥çš„åœ–ç‰‡ / MP4 åœ¨é€™è£¡æ”¹
 *  =========================
 *  type: "image" | "video"
 *  src: ä½ çš„è·¯å¾‘ï¼ˆå¯ç›¸å°æˆ–å®Œæ•´ç¶²å€ï¼‰
 *
 *  å»ºè­°ï¼šæŠŠæª”æ¡ˆæ”¾åœ¨åŒä¸€è³‡æ–™å¤¾çš„ /assets/ å…§
 *  ä¾‹ï¼šassets/stage1.mp4ã€assets/stage2.png
 */
const INTRO_MEDIA = {
  lobby: { type:"image", src:"assets/intro_cover.png", title:"æº–å‚™é–‹å§‹", hint:"é»æ“Šç¹¼çºŒ" },
  s1:    { type:"image", src:"assets/intro_stage1.png", title:"Stage 1ï½œäº‹ä»¶å›é¡§", hint:"é»æ“Šç¹¼çºŒ" },
  s2:    { type:"image", src:"assets/intro_stage2.png", title:"Stage 2ï½œå•é¡ŒæŒ–æ˜", hint:"é»æ“Šç¹¼çºŒ" },
  s3:    { type:"image", src:"assets/intro_stage3.png", title:"Stage 3ï½œé»å­ç”Ÿæˆ", hint:"é»æ“Šç¹¼çºŒ" },
  vote:  { type:"image", src:"assets/intro_vote.png",  title:"æŠ•ç¥¨ï½œè³‡æºå¹£", hint:"é»æ“Šç¹¼çºŒ" },
  s4:    { type:"image", src:"assets/intro_stage4.png", title:"Stage 4ï½œè¡Œå‹•å¥‘ç´„", hint:"é»æ“Šç¹¼çºŒ" },
  done:  { type:"image", src:"assets/intro_done.png", title:"æ­å–œå®Œæˆ", hint:"é»æ“Šç¹¼çºŒ" },
};

// è±¬éšŠå‹å¡å‡ºç¾å‰çš„åœ–ç‰‡æˆ– mp4ï¼ˆä½ è¦çš„ã€Œæ¨™é¡Œå‡ºç¾å‰ä¹Ÿè¦ã€ï¼‰
const PIG_INTRO_MEDIA = {
  type: "video",
  src: "assets/intro_pig.mp4",
  title: "ğŸ‰ é©šå–œï¼ğŸ½ è±¬è±¬ç¾èº«ï¼",
  hint: "é»æ“Šç¹¼çºŒ"
};

// è±¬éšŠå‹å¡éš¨æ©Ÿæ©Ÿç‡ï¼ˆ0~1ï¼‰
// ä¾‹ï¼š0.25 = 25% æ©Ÿç‡åœ¨æŸä½ç©å®¶å›åˆé–‹å§‹è§¸ç™¼
const PIG_CHANCE = 0.25;

/** =========================
 *  Storage
 *  ========================= */
const LS_LIB = "tsh_proto_lib_v4";
const LS_GAME = "tsh_proto_game_v4";

/** =========================
 *  Defaults
 *  ========================= */
const REACT_EMOS = ["ğŸ‘","ğŸ˜‚","ğŸ˜­","ğŸ”¥","ğŸ«¶"];
const WORD_SMALL_MISTAKE = "å°å¤±èª¤";
const PIG_TITLE_LINE = "ğŸ‰ é©šå–œï¼ğŸ½ è±¬è±¬ç¾èº«ï¼";

function uid(){
  return "u_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);
}

function getDefaultLibrary(){
  return [
    {id:uid(), title:"å®£å‚³å•Ÿå‹•", text:"ä½ å€‘æ˜¯æ€éº¼é–‹å±•çš„ï¼Ÿåæ‡‰å¦‚ä½•ï¼Ÿ", icon:"ğŸ“£"},
    {id:uid(), title:"å‰ä¸€å¤©å¤œæ™š", text:"ç•¶æ™‚æœ‰ä»€éº¼æœ€å¾Œæ€¥æ•‘æƒ…æ³ï¼Ÿ", icon:"ğŸ›ï¸"},
    {id:uid(), title:"é–‹å ´ä¸»æŒ", text:"ç•¶æ™‚æ„Ÿå—åˆ°çš„æ°£æ°›æ˜¯ä»€éº¼ï¼Ÿ", icon:"ğŸ’¬"},
    {id:uid(), title:"è‡¨å ´çªç™¼", text:"æœ‰æ²’æœ‰èª°åšäº†ç¥æ•‘æ´ï¼Ÿæˆ–åè€Œæ›´äº‚ï¼Ÿ", icon:"âš¡"},
    {id:uid(), title:"ç¾å ´äº’å‹•", text:"è§€çœ¾/åƒèˆ‡è€…çš„åæ‡‰æœ‰ä»€éº¼æ„å¤–ï¼Ÿ", icon:"ğŸ§‘â€ğŸ¤â€ğŸ§‘"},

    // âœ… ä½ æ–°å¢çš„ 5 å¼µ
    {id:uid(), title:"å·¥ä½œåˆ†é…", text:"å·¥ä½œæ˜¯æ€éº¼åˆ†çš„ï¼Ÿæœ‰äººåšå¾—ç‰¹åˆ¥å¤šæˆ–ç‰¹åˆ¥å°‘å—ï¼Ÿ", icon:"ğŸ§©"},
    {id:uid(), title:"æ„è¦‹è¡çª", text:"ç•¶å¤§å®¶æƒ³æ³•ä¸åŒæ™‚ï¼Œæ˜¯æ€éº¼åšæ±ºå®šçš„ï¼Ÿ", icon:"âš¡"},
    {id:uid(), title:"éš±å½¢å‹å‹•", text:"æœ‰æ²’æœ‰è¢«å¿½ç•¥å»å¾ˆé‡è¦çš„å·¥ä½œï¼Ÿèª°åœ¨åšï¼Ÿ", icon:"ğŸ‘€"},
    {id:uid(), title:"æ™‚é–“å£“åŠ›", text:"åœ¨æœŸé™é€¼è¿‘æ™‚ï¼Œä½ å€‘å„ªå…ˆçŠ§ç‰²äº†ä»€éº¼ï¼Ÿ", icon:"â°"},
    {id:uid(), title:"æºé€šæ–·å±¤", text:"è³‡è¨Šæœ‰æ²’æœ‰é †åˆ©å‚³åˆ°æ¯å€‹äººï¼Ÿèª°è¢«æ’é™¤åœ¨å¤–ï¼Ÿ", icon:"ğŸ“¢"},
  ];
}

function loadLibrary(){
  const raw = localStorage.getItem(LS_LIB);
  if(!raw){
    const lib = getDefaultLibrary();
    localStorage.setItem(LS_LIB, JSON.stringify(lib));
    return lib;
  }
  try{
    const lib = JSON.parse(raw);
    if(Array.isArray(lib) && lib.length) return lib;
  }catch{}
  const fallback = getDefaultLibrary();
  localStorage.setItem(LS_LIB, JSON.stringify(fallback));
  return fallback;
}
function saveLibrary(){ localStorage.setItem(LS_LIB, JSON.stringify(LIB)); }

/** =========================
 *  Game State
 *  ========================= */
function newGame(){
  return {
    meta:{
      roomTitle:"å¤©ä¸‹æ›¸é™¢ï¼šæ‹†è§£ï¼é‡çµ„ï½œå¾©ç›¤",
      accent:"#ff6b9b",
      players:[], // {id,name,growth}
      createdAt: Date.now(),
    },
    stage: "lobby", // lobby | s1 | s2 | s3 | vote | s4 | done
    turn:{
      playerIndex: 0,
      stageRound: 1,
    },

    ui:{
      // åªè¦é€™è£¡æœ‰ pendingKeyï¼Œå°±æœƒå…ˆå½ˆå‡ºåœ–ç‰‡/mp4
      pendingIntroKey: null,
      // è¨˜éŒ„å·²æ’­éçš„ stage introï¼ˆæ¯å€‹ stage é€²ä¾†åªæ’­ä¸€æ¬¡ï¼‰
      shownStageIntro: {}
    },

    decks:{
      eventUsed: [],
    },
    currentCard: null,

    // Stage 2ï¼šå°å¤±èª¤ deckï¼ˆä¸é‡è¤‡ï¼‰ + è±¬éšŠå‹å¡ç‹€æ…‹
    stage2:{
      mistakeDeck: [],
      pointer: 0,
      current: null,

      pig: {
        usedInRound: {},   // {1:true, 2:true}  æ¯ä¸€è¼ªæœ€å¤šä¸€æ¬¡
        active: false      // æ­£åœ¨é¡¯ç¤ºè±¬éšŠå‹å¡
      }
    },

    // Stage 3ï¼šåŸå› æ± ï¼ˆæ¯å€‹åŸå› æœ€å¤š2æ¬¡ï¼‰
    stage3:{
      current: null,
      usage: {},
      capPerCause: 2
    },

    vote:{
      coinsPerPlayer: 7,
      donePlayerIds: [],
      allocations: {}
    },

    stage4:{
      contracts: []
    },

    logs: [],
  };
}

function loadGame(){
  const raw = localStorage.getItem(LS_GAME);
  if(!raw) return newGame();
  try{
    const g = JSON.parse(raw);
    if(g && typeof g==="object") return g;
  }catch{}
  return newGame();
}
function saveGame(){ localStorage.setItem(LS_GAME, JSON.stringify(GAME)); }

/** =========================
 *  Helpers
 *  ========================= */
let LIB = loadLibrary();
let GAME = loadGame();

const $ = (sel)=>document.querySelector(sel);

function toast(msg){
  const el = $("#toast");
  el.textContent = msg;
  el.style.display = "block";
  clearTimeout(el._t);
  el._t = setTimeout(()=>{ el.style.display="none"; }, 2200);
}

function setModeBadge(txt){ $("#modeBadge").textContent = txt; }
function setAccent(hex){ document.documentElement.style.setProperty("--accent", hex || "#ff6b9b"); }

function getPlayers(){ return GAME.meta.players || []; }
function currentPlayer(){
  const ps = getPlayers();
  return ps[GAME.turn.playerIndex] || null;
}
function getPlayer(pid){ return getPlayers().find(p=>p.id===pid); }

function stageName(stage){
  return ({
    lobby:"Lobby",
    s1:"Stage 1ï½œäº‹ä»¶å›é¡§",
    s2:"Stage 2ï½œå•é¡ŒæŒ–æ˜",
    s3:"Stage 3ï½œé»å­ç”Ÿæˆ",
    vote:"æŠ•ç¥¨ï½œè³‡æºå¹£ TOP5",
    s4:"Stage 4ï½œè¡Œå‹•å¥‘ç´„",
    done:"Done"
  })[stage] || stage;
}

function escapeHtml(s){
  return (s??"").toString().replace(/[&<>"']/g, (c)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[c]));
}

function shuffle(arr){
  const a = [...arr];
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

/** =========================
 *  Intro Overlay system
 *  ========================= */
function requestStageIntroIfNeeded(stage){
  GAME.ui = GAME.ui || {pendingIntroKey:null, shownStageIntro:{}};
  GAME.ui.shownStageIntro = GAME.ui.shownStageIntro || {};
  // æ¯å€‹ stage é€²ä¾†åªæ’­ä¸€æ¬¡
  if(!GAME.ui.shownStageIntro[stage]){
    GAME.ui.pendingIntroKey = `stage:${stage}`;
  }
}

function requestPigIntro(){
  GAME.ui = GAME.ui || {pendingIntroKey:null, shownStageIntro:{}};
  GAME.ui.pendingIntroKey = "pig";
}

function renderIntroOverlayIfPending(){
  const key = GAME.ui?.pendingIntroKey;
  if(!key) return false;

  let media = null;

  if(key.startsWith("stage:")){
    const stage = key.split(":")[1];
    media = INTRO_MEDIA[stage] || null;
    // è¨˜ä¸€ä¸‹ã€Œé€™å€‹ stage intro å·²æ’­éã€
    GAME.ui.shownStageIntro = GAME.ui.shownStageIntro || {};
    GAME.ui.shownStageIntro[stage] = true;
  }else if(key==="pig"){
    media = PIG_INTRO_MEDIA;
  }

  // å¦‚æœæ²’è¨­å®šåª’é«”ï¼Œå°±ç›´æ¥ç•¥é
  if(!media || !media.src){
    GAME.ui.pendingIntroKey = null;
    return false;
  }

  const overlay = $("#introOverlay");
  const wrap = $("#introMediaWrap");
  const titleEl = $("#introTitle");
  const hintEl  = $("#introHint");
  const btn     = $("#introContinue");

  titleEl.textContent = media.title || "é–‹å§‹";
  hintEl.textContent  = media.hint  || "é»æ“Šç¹¼çºŒ";

  wrap.innerHTML = "";
  if(media.type==="video"){
    const v = document.createElement("video");
    v.src = media.src;
    v.autoplay = true;
    v.muted = true;      // é¿å…ç€è¦½å™¨æ“‹è‡ªå‹•æ’­æ”¾
    v.playsInline = true;
    v.loop = true;
    v.controls = false;
    wrap.appendChild(v);
  }else{
    const img = document.createElement("img");
    img.src = media.src;
    img.alt = media.title || "intro";
    wrap.appendChild(img);
  }

  overlay.style.display = "flex";
  overlay.setAttribute("aria-hidden","false");

  btn.onclick = ()=>{
    overlay.style.display = "none";
    overlay.setAttribute("aria-hidden","true");
    GAME.ui.pendingIntroKey = null;
    saveGame();
    // intro é—œæ‰å¾Œå† render ä¸€æ¬¡ï¼Œæ‰èƒ½çœ‹åˆ°è©²éšæ®µå…§å®¹
    render();
  };

  saveGame();
  return true;
}

/** Event cards **/
function drawEventCard(){
  const deck = LIB;
  if(deck.length===0) return null;

  const used = GAME.decks.eventUsed || [];
  const remaining = deck.filter(c=>!used.includes(c.id));
  const pool = remaining.length ? remaining : deck;
  const pick = pool[Math.floor(Math.random()*pool.length)];
  used.push(pick.id);
  GAME.decks.eventUsed = used;
  return pick;
}
function ensureEventCard(){
  if(GAME.currentCard) return GAME.currentCard;
  const c = drawEventCard();
  GAME.currentCard = c;
  return c;
}

/** Growth stones **/
function addGrowth(pid, n=1){
  const p = getPlayer(pid);
  if(!p) return;
  p.growth = (p.growth||0) + n;
}
function spendGrowth(pid, n){
  const p = getPlayer(pid);
  if(!p) return false;
  const g = p.growth||0;
  if(g < n) return false;
  p.growth = g - n;
  return true;
}

/** Stage rounds **/
function stageTotalRounds(stage){
  if(stage==="s1") return 2;
  if(stage==="s2") return 2;
  if(stage==="s3") return 2;
  if(stage==="vote") return 1;
  if(stage==="s4") return 1;
  return 1;
}

/** Turn advance **/
function nextTurnOrStage(){
  const ps = getPlayers();
  if(ps.length===0) return;

  if(GAME.turn.playerIndex < ps.length-1){
    GAME.turn.playerIndex += 1;
    GAME.currentCard = null;
    GAME.stage3.current = null;
    GAME.stage2.current = null;
    GAME.stage2.pig.active = false;
    return;
  }

  GAME.turn.playerIndex = 0;
  GAME.turn.stageRound += 1;
  GAME.currentCard = null;
  GAME.stage3.current = null;
  GAME.stage2.current = null;
  GAME.stage2.pig.active = false;

  const totalRounds = stageTotalRounds(GAME.stage);
  if(GAME.turn.stageRound > totalRounds){
    goNextStage();
  }
}

/** Stage transition **/
function goNextStage(){
  const order = ["lobby","s1","s2","s3","vote","s4","done"];
  const idx = order.indexOf(GAME.stage);
  const next = order[Math.min(order.length-1, idx+1)];
  GAME.stage = next;
  GAME.turn.playerIndex = 0;
  GAME.turn.stageRound = 1;
  GAME.currentCard = null;
  GAME.stage3.current = null;
  GAME.stage2.current = null;
  GAME.stage2.pig.active = false;

  if(next==="s2") buildStage2MistakeDeckIfNeeded(true);
  if(next==="s3") initStage3UsageIfNeeded(true);
  if(next==="vote") initVoteIfNeeded(true);

  // âœ… æ¯å€‹éšæ®µé–‹å§‹å‰ intro
  requestStageIntroIfNeeded(next);
}

function goStage(stage){
  GAME.stage = stage;
  GAME.turn.playerIndex = 0;
  GAME.turn.stageRound = 1;
  GAME.currentCard = null;
  GAME.stage3.current = null;
  GAME.stage2.current = null;
  GAME.stage2.pig.active = false;

  if(stage==="s2") buildStage2MistakeDeckIfNeeded(true);
  if(stage==="s3") initStage3UsageIfNeeded(true);
  if(stage==="vote") initVoteIfNeeded(true);

  // âœ… æ¯å€‹éšæ®µé–‹å§‹å‰ intro
  requestStageIntroIfNeeded(stage);
}

/** Logs **/
function addLog(obj){
  const base = {
    id: uid(),
    ts: Date.now(),
    stage: GAME.stage,
    round: GAME.turn.stageRound,
    playerId: obj.playerId,
    playerName: obj.playerName,
    kind: obj.kind,
    prompt: obj.prompt || "",
    fields: obj.fields || {},
    reacts: obj.reacts || {},
  };
  REACT_EMOS.forEach(e=>{ base.reacts[e] = base.reacts[e] || []; });
  GAME.logs.push(base);
  return base;
}
function toggleReact(logId, emo, byPlayerId){
  const log = GAME.logs.find(l=>l.id===logId);
  if(!log) return;
  log.reacts = log.reacts || {};
  log.reacts[emo] = log.reacts[emo] || [];
  const arr = log.reacts[emo];
  const idx = arr.indexOf(byPlayerId);
  if(idx>=0) arr.splice(idx,1);
  else arr.push(byPlayerId);
}

/** =========================
 *  Stage 2: mistake deck (non-repeating)
 *  ========================= */
function getStage1MistakeItems(){
  return (GAME.logs||[])
    .filter(l=>l.stage==="s1" && l.kind==="s1" && (l.fields?.smallMistake||"").trim().length>0)
    .map(l=>({
      fromPlayerId: l.playerId,
      fromPlayerName: l.playerName,
      text: (l.fields.smallMistake||"").trim(),
      sourceLogId: l.id
    }));
}

function buildStage2MistakeDeckIfNeeded(force=false){
  const items = getStage1MistakeItems();
  const need = items.length;
  if(need===0){
    GAME.stage2.mistakeDeck = [];
    GAME.stage2.pointer = 0;
    GAME.stage2.current = null;
    return;
  }
  const deckOk =
    Array.isArray(GAME.stage2.mistakeDeck) &&
    GAME.stage2.mistakeDeck.length === need;

  if(!deckOk || force){
    GAME.stage2.mistakeDeck = shuffle(items);
    GAME.stage2.pointer = 0;
    GAME.stage2.current = null;
  }
}

function drawMistakeNonRepeat(){
  buildStage2MistakeDeckIfNeeded(false);
  const deck = GAME.stage2.mistakeDeck || [];
  if(deck.length===0) return null;

  const idx = GAME.stage2.pointer || 0;
  if(idx >= deck.length) return null;
  const pick = deck[idx];
  GAME.stage2.pointer = idx + 1;
  return pick;
}
function ensureStage2Mistake(){
  if(GAME.stage2.current) return GAME.stage2.current;
  const a = drawMistakeNonRepeat();
  GAME.stage2.current = a;
  return a;
}

/** =========================
 *  Stage 2: pig event (max once per round)
 *  ========================= */
function canTriggerPigThisRound(){
  const r = GAME.turn.stageRound;
  GAME.stage2.pig.usedInRound = GAME.stage2.pig.usedInRound || {};
  return !GAME.stage2.pig.usedInRound[r];
}
function maybeTriggerPigEvent(){
  // åªåœ¨ Stage2 è€Œä¸”ã€Œå›åˆé–‹å§‹ã€æ™‚åˆ¤æ–·
  if(GAME.stage !== "s2") return false;
  if(GAME.stage2.pig.active) return false; // å·²ç¶“åœ¨è±¬å¡ç•«é¢
  if(!canTriggerPigThisRound()) return false;

  // éš¨æ©Ÿæ©Ÿç‡
  if(Math.random() < PIG_CHANCE){
    GAME.stage2.pig.active = true;
    // âœ… è±¬éšŠå‹æ¨™é¡Œå‡ºç¾å‰ï¼Œå…ˆæ’­ intro
    requestPigIntro();
    return true;
  }
  return false;
}

/** =========================
 *  Stage 3: cause pool, each cause max 2 times
 *  ========================= */
function getStage2Causes(){
  return (GAME.logs||[])
    .filter(l=>l.stage==="s2" && l.kind==="s2" && (l.fields?.cause||"").trim().length>0)
    .map(l=>({ text:(l.fields.cause||"").trim(), sourceLogId:l.id }));
}

function initStage3UsageIfNeeded(force=false){
  GAME.stage3 = GAME.stage3 || {};
  if(force || !GAME.stage3.usage){
    GAME.stage3.usage = {};
    GAME.stage3.capPerCause = GAME.stage3.capPerCause || 2;
    GAME.stage3.current = null;
  }
}

function drawCauseMaxTwice(){
  initStage3UsageIfNeeded(false);
  const pool = getStage2Causes();
  if(pool.length===0) return null;

  const usage = GAME.stage3.usage || {};
  const cap = GAME.stage3.capPerCause || 2;

  const eligible = pool.filter(x => (usage[x.sourceLogId]||0) < cap);

  if(eligible.length){
    const pick = eligible[Math.floor(Math.random()*eligible.length)];
    usage[pick.sourceLogId] = (usage[pick.sourceLogId]||0) + 1;
    GAME.stage3.usage = usage;
    return pick;
  }

  const pick = pool[Math.floor(Math.random()*pool.length)];
  toast("âš ï¸ æ‰€æœ‰åŸå› å·²é”2æ¬¡ä¸Šé™ï¼ˆæš«æ™‚æ”¾å¯¬æŠ½å–ä»¥é¿å…å¡ä½ï¼‰");
  return pick;
}

function ensureStage3Cause(){
  if(GAME.stage3.current) return GAME.stage3.current;
  const c = drawCauseMaxTwice();
  GAME.stage3.current = c;
  return c;
}

/** =========================
 *  Voting data
 *  ========================= */
function getStage3Ideas(){
  return (GAME.logs||[])
    .filter(l=>l.stage==="s3" && l.kind==="s3" && (l.fields?.idea||"").trim().length>0)
    .map(l=>({
      ideaId: l.id,
      text:(l.fields.idea||"").trim(),
      causeText:(l.fields.causePrompt||"").trim(),
      fromPlayerName:l.playerName
    }));
}

function initVoteIfNeeded(force=false){
  if(force){
    GAME.vote = GAME.vote || { coinsPerPlayer: 7, donePlayerIds: [], allocations:{} };
    GAME.vote.coinsPerPlayer = 7;
    GAME.vote.donePlayerIds = [];
    GAME.vote.allocations = {};
    return;
  }
  if(!GAME.vote) GAME.vote = { coinsPerPlayer: 7, donePlayerIds: [], allocations:{} };
}

function voteRemainingCoins(pid){
  const alloc = GAME.vote.allocations || {};
  let spent = 0;
  Object.values(alloc).forEach(v=>{
    spent += (v.byPlayer?.[pid]||0);
  });
  return GAME.vote.coinsPerPlayer - spent;
}

function voteAdd(ideaId, pid, delta){
  GAME.vote.allocations = GAME.vote.allocations || {};
  const a = GAME.vote.allocations[ideaId] || { total:0, byPlayer:{} };
  a.byPlayer[pid] = (a.byPlayer[pid]||0) + delta;
  if(a.byPlayer[pid] < 0) a.byPlayer[pid] = 0;
  a.total = Object.values(a.byPlayer).reduce((s,n)=>s+n,0);
  GAME.vote.allocations[ideaId] = a;
}

function computeTop5(){
  const ideas = getStage3Ideas();
  const alloc = GAME.vote.allocations || {};
  const scored = ideas.map(it=>{
    const total = alloc[it.ideaId]?.total || 0;
    return { ...it, total };
  }).sort((a,b)=> b.total - a.total || a.ideaId.localeCompare(b.ideaId));
  return scored.slice(0,5);
}

function allVoteDone(){
  const ps = getPlayers();
  const done = new Set(GAME.vote.donePlayerIds||[]);
  return ps.length>0 && ps.every(p=>done.has(p.id));
}

/** =========================
 *  CSV Export: UTF-16LE + BOM (Excel safe)
 *  ========================= */
function csvEscape(v){
  const s = (v ?? "").toString();
  if(/[,"\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
  return s;
}
function formatDate(ts){
  try{ return new Date(ts).toISOString(); }catch{ return ""; }
}
function encodeUTF16LE(str){
  const buf = new Uint8Array(str.length * 2);
  for(let i=0;i<str.length;i++){
    const code = str.charCodeAt(i);
    buf[i*2] = code & 0xFF;
    buf[i*2+1] = (code >> 8) & 0xFF;
  }
  return buf;
}

function exportCSV(){
  const ps = getPlayers();
  const top5 = computeTop5();
  const contracts = GAME.stage4.contracts || [];

  const rows = [];

  rows.push([
    "type","ts","stage","round","player",
    "s1_success",`s1_${WORD_SMALL_MISTAKE}`,"s1_card_answer","s1_card_title","s1_card_text","s1_card_icon",
    `s2_${WORD_SMALL_MISTAKE}_prompt`,"s2_cause",
    "pig_mistake","pig_avoid",
    "s3_cause_prompt","s3_idea",
    "react_ğŸ‘","react_ğŸ˜‚","react_ğŸ˜­","react_ğŸ”¥","react_ğŸ«¶"
  ]);

  (GAME.logs||[]).forEach(l=>{
    const f = l.fields || {};
    rows.push([
      "log",
      formatDate(l.ts),
      l.stage,
      l.round,
      l.playerName,

      f.success||"",
      f.smallMistake||"",
      f.cardAnswer||"",
      f.cardTitle||"",
      f.cardText||"",
      f.cardIcon||"",

      f.smallMistakePrompt||"",
      f.cause||"",

      f.pigMistake||"",
      f.pigAvoid||"",

      f.causePrompt||"",
      f.idea||"",

      (l.reacts?.["ğŸ‘"]||[]).length,
      (l.reacts?.["ğŸ˜‚"]||[]).length,
      (l.reacts?.["ğŸ˜­"]||[]).length,
      (l.reacts?.["ğŸ”¥"]||[]).length,
      (l.reacts?.["ğŸ«¶"]||[]).length,
    ]);
  });

  rows.push([]);
  rows.push(["type","idea_id","cause","idea_text","from_player","votes_total"]);
  top5.forEach(x=>{
    rows.push(["top5", x.ideaId, x.causeText, x.text, x.fromPlayerName, x.total]);
  });

  rows.push([]);
  rows.push(["type","ts","player","cause","idea","can_do","help"]);
  contracts.forEach(c=>{
    rows.push(["contract", formatDate(c.ts), (getPlayer(c.playerId)?.name||""), c.causeText||"", c.ideaText||"", c.canDo||"", c.help||""]);
  });

  rows.push([]);
  rows.push(["type","player","growth_stones"]);
  ps.forEach(p=> rows.push(["player", p.name, p.growth||0]));

  const csv = rows.map(r=>r.map(csvEscape).join(",")).join("\n");
  const bom = new Uint8Array([0xFF, 0xFE]);
  const data = encodeUTF16LE(csv);
  const blob = new Blob([bom, data], {type:"text/csv;charset=utf-16le"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `tsh_debrief_${Date.now()}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast("ğŸ“¤ å·²åŒ¯å‡º CSVï¼ˆExcel ä¸äº‚ç¢¼ï¼‰");
}

/** Reset **/
function hardReset(){
  if(!confirm("ç¢ºå®šè¦é‡ç½®æœ¬å±€ï¼Ÿï¼ˆç©å®¶åå–®ã€ç´€éŒ„ã€æŠ•ç¥¨ã€å¥‘ç´„éƒ½æ¸…ç©ºï¼›å¡ç‰‡åº«ä¿ç•™ï¼‰")) return;
  GAME = newGame();
  saveGame();
  toast("å·²é‡ç½®æœ¬å±€");
  render();
}

/** =========================
 *  UI Render
 *  ========================= */
const mainPanel = $("#mainPanel");
const sidePanel = $("#sidePanel");

function render(){
  setAccent(GAME.meta.accent);
  saveGame();

  // âœ… è‹¥æœ‰ pending introï¼Œå…ˆé¡¯ç¤º overlayï¼ˆæœƒé˜»æ“‹å¾Œé¢çš„ç•«é¢ï¼‰
  if(renderIntroOverlayIfPending()) return;

  if(GAME.stage==="lobby"){
    setModeBadge("Lobby");
    renderLobby();
    renderSide();
  }else if(GAME.stage==="s1"){
    setModeBadge("Stage 1");
    renderStage1();
    renderSide();
  }else if(GAME.stage==="s2"){
    setModeBadge("Stage 2");
    renderStage2();
    renderSide();
  }else if(GAME.stage==="s3"){
    setModeBadge("Stage 3");
    renderStage3();
    renderSide(true);
  }else if(GAME.stage==="vote"){
    setModeBadge("Vote");
    renderVote();
    renderSide(true);
  }else if(GAME.stage==="s4"){
    setModeBadge("Stage 4");
    renderStage4();
    renderSide(true);
  }else if(GAME.stage==="done"){
    setModeBadge("Done");
    renderDone();
    renderSide(true);
  }
}

/** Side panel **/
function renderSide(showStrategyInfo=false){
  const ps = getPlayers();
  const cur = currentPlayer();

  const headerRow = `
    <div class="row" style="justify-content:space-between; align-items:center">
      <div>
        <div style="font-weight:900">ç©å®¶è³‡æºï¼ˆæˆé•·çŸ³ï¼‰</div>
        <div class="hint">æ¯æ¬¡æäº¤ +1ï½œèŠ± 1 é¡†é‡æŠ½å¡ï½œèŠ± 2 é¡†è·³é</div>
      </div>
      <span class="pill">${ps.length} äºº</span>
    </div>
  `;

  const strategyHint = showStrategyInfo ? `
    <div style="height:10px"></div>
    <div class="lockBanner">
      ğŸ¯ ç­–ç•¥æç¤ºï¼šStage3 åŒä¸€å€‹ã€ŒåŸå› ã€æœ€å¤šæŠ½åˆ° 2 æ¬¡ï¼ˆå…¨å±€ï¼‰ã€‚<br/>
      è®“é»å­åˆ†å¸ƒæ›´å¹³å‡ï¼Œä¸æœƒä¸€ç›´å¡åŒä¸€å€‹æ ¹å› ã€‚
    </div>
  ` : "";

  sidePanel.innerHTML = `
    ${headerRow}
    <div style="height:10px"></div>

    <details open>
      <summary>ğŸ‘¥ ç©å®¶åå–®ï¼ˆé»æ“Šæ”¶åˆï¼‰ <span class="pill">${ps.length}</span></summary>
      <div style="height:10px"></div>
      <div class="row">
        <input class="input" id="newPlayer" placeholder="è¼¸å…¥ç©å®¶åå­—â€¦" />
        <button class="btn small primary" id="btnAddPlayer">â• åŠ å…¥</button>
      </div>
      <div class="hint" style="margin-top:8px">å»ºè­° 3â€“8 äººï¼›å–®æ©Ÿè¼ªæµæ“ä½œã€‚</div>
      <div style="height:10px"></div>
      <div class="row">
        <button class="btn small" id="btnShuffleOrder">ğŸ”€ éš¨æ©Ÿé †åºï¼ˆå›ºå®šæœ¬å±€ï¼‰</button>
        <button class="btn small danger" id="btnClearPlayers">æ¸…ç©ºç©å®¶</button>
      </div>
      <div class="hr"></div>
      <div id="playersBox" class="row" style="flex-direction:column; gap:10px"></div>
    </details>

    <div style="height:12px"></div>
    <details>
      <summary>ğŸ´ äº‹ä»¶å¡åº«ï¼ˆæ–°å¢/ç·¨è¼¯ï½œé»æ“Šæ”¶åˆï¼‰ <span class="pill">${LIB.length}</span></summary>
      <div class="hint" style="margin-top:8px">åªåšã€Œæ–°å¢ï¼‹åˆªé™¤ã€ï¼‹å¿«é€Ÿé è¦½ï¼Œé¿å…ç·¨è¼¯å™¨åœ°ç„ã€‚</div>
      <div style="height:10px"></div>

      <div class="two">
        <div>
          <label class="hint">å¡ç‰‡æ¨™é¡Œ</label>
          <input class="input" id="cardTitle" placeholder="ä¾‹ï¼šå®£å‚³å•Ÿå‹•" />
        </div>
        <div>
          <label class="hint">Iconï¼ˆå¯ç©ºï¼‰</label>
          <input class="input" id="cardIcon" placeholder="ä¾‹ï¼šğŸ“£" />
        </div>
      </div>
      <div style="height:8px"></div>
      <label class="hint">å¡ç‰‡å•é¡Œ</label>
      <textarea id="cardText" maxlength="160" placeholder="ä¾‹ï¼šä½ å€‘æ˜¯æ€éº¼é–‹å±•çš„ï¼Ÿåæ‡‰å¦‚ä½•ï¼Ÿ"></textarea>

      <div style="height:10px"></div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn small primary" id="btnAddCard">â• æ–°å¢å¡ç‰‡</button>
      </div>

      <div class="hr"></div>
      <div id="cardList" style="display:flex; flex-direction:column; gap:10px"></div>
    </details>

    ${strategyHint}

    <div style="height:12px"></div>
    <details open>
      <summary>ğŸ§± ç´€éŒ„ç‰†ï¼ˆå…¨éƒ¨æäº¤ï¼‰ <span class="pill">${(GAME.logs||[]).length}</span></summary>
      <div class="hint" style="margin-top:8px">é»è¡¨æƒ…å¯åŠ /å¯æ”¶å›ï¼ˆä»¥ã€Œç›®å‰è¼ªåˆ°çš„ç©å®¶ã€èº«åˆ†ï¼‰ã€‚</div>
      <div style="height:10px"></div>
      <div id="logsBox"></div>
    </details>
  `;

  // players list
  const pb = $("#playersBox");
  pb.innerHTML = ps.map((p,i)=>`
    <div class="listItem" style="align-items:center; ${cur && p.id===cur.id ? "border-color:rgba(255,107,155,.45); box-shadow:0 10px 20px rgba(255,107,155,.10);" : ""}">
      <div class="row" style="gap:10px">
        <div class="miniIcon">${escapeHtml(p.name.slice(0,1))}</div>
        <div>
          <div style="font-weight:900">${escapeHtml(p.name)} ${cur && p.id===cur.id ? "<span class='pill accent'>ç›®å‰è¼ªåˆ°</span>" : ""}</div>
          <div class="hint">ğŸª¨ æˆé•·çŸ³ï¼š<b>${p.growth||0}</b></div>
        </div>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn tiny" data-act="up" data-i="${i}">â¬†ï¸</button>
        <button class="btn tiny" data-act="down" data-i="${i}">â¬‡ï¸</button>
        <button class="btn tiny" data-act="rm" data-i="${i}">ç§»é™¤</button>
      </div>
    </div>
  `).join("");

  pb.querySelectorAll("button[data-act]").forEach(b=>{
    b.onclick = ()=>{
      const act = b.dataset.act;
      const i = Number(b.dataset.i);
      if(act==="rm"){
        if(!confirm("ç§»é™¤ç©å®¶ï¼Ÿ")) return;
        GAME.meta.players.splice(i,1);
        if(GAME.turn.playerIndex >= GAME.meta.players.length) GAME.turn.playerIndex = 0;
      }else if(act==="up" && i>0){
        [GAME.meta.players[i-1], GAME.meta.players[i]] = [GAME.meta.players[i], GAME.meta.players[i-1]];
      }else if(act==="down" && i < GAME.meta.players.length-1){
        [GAME.meta.players[i+1], GAME.meta.players[i]] = [GAME.meta.players[i], GAME.meta.players[i+1]];
      }
      render();
    };
  });

  // add player
  $("#btnAddPlayer").onclick = ()=>{
    const name = ($("#newPlayer").value||"").trim();
    if(!name) return toast("è«‹è¼¸å…¥åå­—");
    if(getPlayers().length>=8) return toast("æœ€å¤š 8 äºº");
    GAME.meta.players.push({id:uid(), name, growth:0});
    $("#newPlayer").value="";
    render();
  };

  // shuffle
  $("#btnShuffleOrder").onclick = ()=>{
    if(getPlayers().length<2) return toast("è‡³å°‘2äººæ‰éœ€è¦æ´—ç‰Œ");
    GAME.meta.players = shuffle(GAME.meta.players);
    GAME.turn.playerIndex = 0;
    toast("å·²éš¨æ©Ÿé †åºï¼ˆæœ¬å±€å›ºå®šï¼‰");
    render();
  };

  // clear players
  $("#btnClearPlayers").onclick = ()=>{
    if(!confirm("æ¸…ç©ºç©å®¶åå–®ï¼Ÿï¼ˆæœƒå½±éŸ¿æœ¬å±€æµç¨‹èˆ‡æŠ•ç¥¨ï¼‰")) return;
    GAME.meta.players = [];
    GAME.turn.playerIndex = 0;
    render();
  };

  /** Card library UI **/
  const cl = $("#cardList");
  cl.innerHTML = LIB.map((c,idx)=>`
    <div class="listItem" style="align-items:center">
      <div style="min-width:0">
        <div style="font-weight:900; display:flex; gap:8px; align-items:center">
          <span>${escapeHtml(c.icon || "ğŸ´")}</span>
          <span>${escapeHtml(c.title || "ï¼ˆç„¡æ¨™é¡Œï¼‰")}</span>
        </div>
        <div class="hint" style="margin-top:4px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
          ${escapeHtml(c.text || "")}
        </div>
      </div>
      <div class="row" style="justify-content:flex-end">
        <button class="btn tiny danger" data-card-rm="${idx}">åˆªé™¤</button>
      </div>
    </div>
  `).join("") || `<div class="hint">ï¼ˆç›®å‰æ²’æœ‰å¡ç‰‡ï¼‰</div>`;

  cl.querySelectorAll("button[data-card-rm]").forEach(btn=>{
    btn.onclick = ()=>{
      const idx = Number(btn.dataset.cardRm);
      if(!confirm("åˆªé™¤é€™å¼µå¡ç‰‡ï¼Ÿ")) return;
      const removed = LIB.splice(idx,1);
      saveLibrary();
      toast(`å·²åˆªé™¤ï¼š${removed?.[0]?.title || "å¡ç‰‡"}`);
      if(GAME.currentCard && removed[0] && GAME.currentCard.id === removed[0].id){
        GAME.currentCard = null;
      }
      render();
    };
  });

  $("#btnAddCard").onclick = ()=>{
    const title = ($("#cardTitle").value||"").trim();
    const text = ($("#cardText").value||"").trim();
    const icon = ($("#cardIcon").value||"").trim();
    if(!title || !text) return toast("è«‹è‡³å°‘å¡«å¡ç‰‡æ¨™é¡Œï¼‹å¡ç‰‡å•é¡Œ");
    LIB.unshift({id:uid(), title, text, icon});
    saveLibrary();
    $("#cardTitle").value = "";
    $("#cardText").value = "";
    $("#cardIcon").value = "";
    toast("å·²æ–°å¢å¡ç‰‡");
    render();
  };

  // logs wall
  $("#logsBox").innerHTML = renderLogsWall();

  // bind emoji toggles
  $("#logsBox").querySelectorAll("[data-log][data-emo]").forEach(el=>{
    el.onclick = ()=>{
      const logId = el.dataset.log;
      const emo = el.dataset.emo;
      const curP = currentPlayer() || getPlayers()[0];
      if(!curP) return toast("è«‹å…ˆå»ºç«‹ç©å®¶åå–®");
      toggleReact(logId, emo, curP.id);
      render();
    };
  });
}

/** Logs wall **/
function renderLogsWall(){
  const logs = GAME.logs || [];
  if(logs.length===0) return `<div class="hint">ï¼ˆå°šç„¡ä»»ä½•æäº¤ï¼‰</div>`;

  const stageOrder = ["s1","s2","s3","vote","s4","done"];
  const groups = {};
  logs.forEach(l=>{
    const k = `${l.stage}::${l.round}`;
    groups[k] = groups[k] || [];
    groups[k].push(l);
  });

  const keys = Object.keys(groups).sort((a,b)=>{
    const [sa,ra] = a.split("::");
    const [sb,rb] = b.split("::");
    const ia = stageOrder.indexOf(sa);
    const ib = stageOrder.indexOf(sb);
    if(ia!==ib) return ia-ib;
    return Number(ra)-Number(rb);
  });

  return keys.map(k=>{
    const [st, rd] = k.split("::");
    const title = `${stageName(st)}ï½œç¬¬ ${rd} è¼ª`;
    const items = groups[k].sort((x,y)=>x.ts-y.ts).map(l=>{
      const f = l.fields||{};
      let body = "";
      if(l.stage==="s1"){
        body = `
          <div class="tagRow"><span class="pill ok">âœ… æˆåŠŸ</span><span class="hint">${escapeHtml(f.success||"")}</span></div>
          <div class="tagRow"><span class="pill danger">ğŸ§© ${WORD_SMALL_MISTAKE}</span><span class="hint">${escapeHtml(f.smallMistake||"")}</span></div>
          <div class="tagRow"><span class="pill accent">ğŸ´ å¡ç‰‡å›ç­”</span><span class="hint">${escapeHtml(f.cardAnswer||"")}</span></div>
          <div class="hint" style="margin-top:8px">
            <b>æŠ½åˆ°å¡ï¼š</b>${escapeHtml(f.cardIcon||"ğŸ´")} ${escapeHtml(f.cardTitle||"")}<br/>
            <span class="hint">${escapeHtml(f.cardText||"")}</span>
          </div>
        `;
      }else if(l.stage==="s2" && l.kind==="pig"){
        body = `
          <div class="hint"><b>${PIG_TITLE_LINE}</b></div>
          <div class="hint"><b>éŒ¯ï¼š</b>${escapeHtml(f.pigMistake||"")}</div>
          <div class="hint"><b>å¦‚ä½•é¿å…ï¼š</b>${escapeHtml(f.pigAvoid||"")}</div>
        `;
      }else if(l.stage==="s2"){
        body = `
          <div class="hint"><b>${WORD_SMALL_MISTAKE}ï¼š</b>${escapeHtml(f.smallMistakePrompt||"")}</div>
          <div class="hint"><b>ç‚ºä»€éº¼æœƒç™¼ç”Ÿï¼š</b>${escapeHtml(f.cause||"")}</div>
        `;
      }else if(l.stage==="s3"){
        body = `
          <div class="hint"><b>åŸå› ï¼š</b>${escapeHtml(f.causePrompt||"")}</div>
          <div class="hint"><b>é»å­ï¼š</b>${escapeHtml(f.idea||"")}</div>
        `;
      }else if(l.kind==="contract"){
        body = `
          <div class="hint"><b>åŸå› ï¼š</b>${escapeHtml(f.contractCause||"")}</div>
          <div class="hint"><b>é»å­ï¼š</b>${escapeHtml(f.contractIdea||"")}</div>
          <div class="hint"><b>æˆ‘å¯ä»¥åšä»€éº¼ï¼š</b>${escapeHtml(f.contractCanDo||"")}</div>
          <div class="hint"><b>éœ€è¦å”åŠ©ï¼š</b>${escapeHtml(f.contractHelp||"")}</div>
        `;
      }

      const reacts = REACT_EMOS.map(e=>{
        const n = (l.reacts?.[e]||[]).length;
        return `<span class="tag" data-log="${l.id}" data-emo="${e}">${e} ${n}</span>`;
      }).join("");

      return `
        <div class="card" style="margin:10px 0">
          <div class="head">
            <div class="title">
              <div class="icon">ğŸ§¾</div>
              <div>
                <div style="font-weight:900">${escapeHtml(l.playerName)}</div>
                <div class="hint">${new Date(l.ts).toLocaleString()}</div>
              </div>
            </div>
            <span class="pill">${escapeHtml(l.kind||"")}</span>
          </div>
          <div class="body">
            ${body}
            <div class="tagRow" style="margin-top:10px">${reacts}</div>
          </div>
        </div>
      `;
    }).join("");

    return `
      <div class="lockBanner" style="margin:10px 0">${escapeHtml(title)}</div>
      ${items}
    `;
  }).join("");
}

/** =========================
 *  Lobby
 *  ========================= */
function renderLobby(){
  mainPanel.innerHTML = `
    <h2 style="margin:0 0 8px">å»ºç«‹ä¸€å±€ï¼ˆå››éšæ®µæŒ‰é †åºï¼‹æŠ•ç¥¨ï¼‰</h2>
    <div class="hint">
      Stage1ï¼šæˆåŠŸï¼‹${WORD_SMALL_MISTAKE}ï¼‹å›ç­”äº‹ä»¶å¡å•é¡Œï¼ˆ+1ğŸª¨ï¼‰ï½œ2è¼ª<br/>
      Stage2ï¼šå¾æ‰€æœ‰${WORD_SMALL_MISTAKE}éš¨æ©ŸæŠ½ï¼ˆä¸é‡è¤‡ï¼‰â†’ å¡«ã€Œç‚ºä»€éº¼æœƒç™¼ç”Ÿã€ï¼ˆ+1ğŸª¨ï¼‰ï½œ2è¼ª<br/>
      â˜… Stage2ï¼šå¯èƒ½éš¨æ©Ÿå‡ºç¾ã€Œè±¬éšŠå‹å¡ã€ï¼Œæ¯è¼ªæœ€å¤šä¸€æ¬¡ï¼ˆå„²å­˜ +3ğŸª¨ï¼‰<br/>
      Stage3ï¼šå¾æ‰€æœ‰åŸå› éš¨æ©ŸæŠ½ï¼ˆæ¯å€‹åŸå› æœ€å¤š2æ¬¡ï¼‰â†’ å¯«é»å­ï¼ˆ+1ğŸª¨ï¼‰ï½œ2è¼ª<br/>
      æŠ•ç¥¨ï¼šæ¯äºº 7 æšè³‡æºå¹£ â†’ TOP5 é»å­<br/>
      Stage4ï¼šæ¯äººé¸ TOP5 ä¹‹ä¸€å¡«å¥‘ç´„ï¼ˆé¡¯ç¤ºåŸå› +é»å­ï¼‰â†’ çµæŸè©¢å•åŒ¯å‡º CSV
    </div>
    <div class="hr"></div>

    <label class="hint">æˆ¿é–“æ¨™é¡Œ</label>
    <input class="input" id="roomTitle" value="${escapeHtml(GAME.meta.roomTitle)}" />

    <div style="height:10px"></div>
    <label class="hint">ä¸»è‰² Accent</label>
    <input class="input" id="roomAccent" value="${escapeHtml(GAME.meta.accent)}" />

    <div style="height:12px"></div>
    <div class="lockBanner">
      ğŸ² æé†’ï¼šå³å´å…ˆåŠ å…¥ç©å®¶ï¼ˆ3â€“8 äººï¼‰å†é–‹å§‹ã€‚<br/>
      å…¨ç¨‹è‡ªå‹•ä¿å­˜ï¼Œå¯éš¨æ™‚é—œæ‰å†æ‰“é–‹ç¹¼çºŒã€‚
    </div>

    <div style="height:12px"></div>
    <div class="row" style="justify-content:flex-end">
      <button class="btn primary" id="btnStart">â–¶ï¸ é–‹å§‹ Stage 1</button>
    </div>
  `;

  $("#roomTitle").oninput = e=>{ GAME.meta.roomTitle = e.target.value; render(); };
  $("#roomAccent").oninput = e=>{ GAME.meta.accent = e.target.value; render(); };

  $("#btnStart").onclick = ()=>{
    const n = getPlayers().length;
    if(n<3 || n>8) return toast("ç©å®¶éœ€ 3â€“8 äººï¼ˆå…ˆåœ¨å³å´åŠ å…¥ç©å®¶ï¼‰");
    goStage("s1");
    toast("é–‹å§‹ Stage 1ï¼ˆç¬¬1è¼ªï¼‰");
    render();
  };
}

/** =========================
 *  Stage 1
 *  ========================= */
function renderStage1(){
  const ps = getPlayers();
  const p = currentPlayer();
  if(!p){ goStage("lobby"); return render(); }

  const card = ensureEventCard();
  if(!card) return mainPanel.innerHTML = `<div class="hint">äº‹ä»¶å¡åº«ç‚ºç©ºï¼ˆå³å´å¯æ–°å¢å¡ç‰‡ï¼‰</div>`;

  mainPanel.innerHTML = `
    <h2 style="margin:0 0 6px">ç¬¬1éšæ®µï½œäº‹ä»¶å›é¡§ What Happened?</h2>
    <div class="hint">å›ºå®šå…©è¼ªï¼šç›®å‰ <b>ç¬¬ ${GAME.turn.stageRound} / 2 è¼ª</b>ã€‚æäº¤ä¸€æ¬¡ = +1 æˆé•·çŸ³ã€‚</div>
    <div class="hr"></div>

    <div class="row" style="justify-content:space-between">
      <div class="chip ok">è¼ªåˆ°ï¼š<b>${escapeHtml(p.name)}</b>ï¼ˆ${GAME.turn.playerIndex+1}/${ps.length}ï¼‰</div>
      <div class="chip warn">è¼ªæ•¸ï¼šç¬¬ <b>${GAME.turn.stageRound}</b> è¼ª</div>
    </div>

    <div style="height:10px"></div>
    <div class="card">
      <div class="head">
        <div class="title">
          <div class="icon">${escapeHtml(card.icon || "ğŸ´")}</div>
          <div>
            <div style="font-weight:900">${escapeHtml(card.title)}</div>
            <div class="hint">${escapeHtml(card.text)}</div>
          </div>
        </div>
        <span class="pill accent">äº‹ä»¶å¡å•é¡Œ</span>
      </div>
      <div class="body">
        <div class="bigQ">${escapeHtml(card.text)}</div>
        <div class="sub">æœ¬éšæ®µéœ€è¦å¡«ï¼šæˆåŠŸã€${WORD_SMALL_MISTAKE}ã€ä»¥åŠå¡ç‰‡å•é¡Œå›ç­”ï¼ˆæœƒè¨˜éŒ„ä½ æŠ½åˆ°å“ªå¼µå¡ï¼‰ã€‚</div>
      </div>
    </div>

    <div style="height:10px"></div>
    <div class="two">
      <div>
        <label class="hint">âœ… æœ€æˆåŠŸï¼ˆé—œéµå­—å³å¯ï¼‰</label>
        <textarea id="s1Success" maxlength="140" placeholder="ä¾‹ï¼šå®£å‚³è²¼æ–‡è¢«è½‰ç™¼ã€å ±åç¬é–“æ»¿â€¦"></textarea>
      </div>
      <div>
        <label class="hint">ğŸ§© ${WORD_SMALL_MISTAKE}ï¼ˆé—œéµå­—å³å¯ï¼‰</label>
        <textarea id="s1Mistake" maxlength="140" placeholder="ä¾‹ï¼šç‰©è³‡å°‘å¸¶ã€æ™‚é–“ä¼°éŒ¯ã€å†·å ´â€¦"></textarea>
      </div>
    </div>

    <div style="height:10px"></div>
    <label class="hint">ğŸ´ å›ç­”å¡ç‰‡å•é¡Œï¼ˆæœ€å¤š160å­—ï¼‰</label>
    <textarea id="s1CardAnswer" maxlength="160" placeholder="é‡å°ä¸Šæ–¹äº‹ä»¶å¡é¡Œç›®å›ç­”â€¦"></textarea>

    <div style="height:10px"></div>
    <div class="row" style="justify-content:space-between">
      <div class="hint">
        æˆé•·çŸ³ï¼š<b>${p.growth||0}</b>ï½œ
        <span class="kbd">èŠ± 1</span> é‡æŠ½äº‹ä»¶å¡ï½œ
        <span class="kbd">èŠ± 2</span> è·³éæœ¬å›åˆï¼ˆä¸‹ä¸€ä½ï¼‰
      </div>
      <div class="row">
        <button class="btn small" id="btnRedraw">ğŸª¨-1 é‡æŠ½</button>
        <button class="btn small danger" id="btnSkip">ğŸª¨-2 è·³é</button>
        <button class="btn small primary" id="btnSubmit">æäº¤ï¼ˆ+1ğŸª¨ï¼‰</button>
      </div>
    </div>
  `;

  $("#btnRedraw").onclick = ()=>{
    if(!spendGrowth(p.id, 1)) return toast("æˆé•·çŸ³ä¸è¶³ï¼ˆéœ€è¦ 1 é¡†ï¼‰");
    GAME.currentCard = null;
    toast("å·²é‡æŠ½äº‹ä»¶å¡");
    render();
  };

  $("#btnSkip").onclick = ()=>{
    if(!spendGrowth(p.id, 2)) return toast("æˆé•·çŸ³ä¸è¶³ï¼ˆéœ€è¦ 2 é¡†ï¼‰");
    GAME.currentCard = null;
    toast("å·²è·³éï¼ˆæ›ä¸‹ä¸€ä½ï¼‰");
    nextTurnOrStage();
    render();
  };

  $("#btnSubmit").onclick = ()=>{
    const success = ($("#s1Success").value||"").trim();
    const smallMistake = ($("#s1Mistake").value||"").trim();
    const cardAnswer = ($("#s1CardAnswer").value||"").trim();
    if(!success || !smallMistake || !cardAnswer) return toast(`æˆåŠŸã€${WORD_SMALL_MISTAKE}ã€å¡ç‰‡å›ç­”éƒ½è¦å¡«`);

    addLog({
      playerId: p.id,
      playerName: p.name,
      kind: "s1",
      prompt: card.text,
      fields: {
        success,
        smallMistake,
        cardAnswer,
        cardTitle: card.title,
        cardText: card.text,
        cardIcon: card.icon || ""
      },
      reacts: {}
    });

    addGrowth(p.id, 1);
    toast("å·²æäº¤ï¼š+1 æˆé•·çŸ³");
    GAME.currentCard = null;

    nextTurnOrStage();

    if(GAME.stage==="s2") buildStage2MistakeDeckIfNeeded(true);

    render();
  };
}

/** =========================
 *  Stage 2
 *  ========================= */
function renderStage2(){
  const ps = getPlayers();
  const p = currentPlayer();
  if(!p){ goStage("lobby"); return render(); }

// âœ… å…ˆå˜—è©¦è§¸ç™¼è±¬éšŠå‹å¡ï¼ˆæ¯è¼ªæœ€å¤šä¸€æ¬¡ï¼‰
// è§¸ç™¼å¾Œç«‹åˆ»é‡æ–° renderï¼Œè®“ overlay å…ˆè·³å‡ºä¾†ï¼ˆä¸€å®šåœ¨å¡«å¯«å‰ï¼‰
if(maybeTriggerPigEvent()){
  saveGame();
  return render();
}

  // è‹¥è±¬éšŠå‹å¡ç›®å‰æ˜¯ activeï¼Œç›´æ¥é¡¯ç¤ºè±¬éšŠå‹å¡ UI
  if(GAME.stage2.pig.active){
    return renderPigCardStage2();
  }

  buildStage2MistakeDeckIfNeeded(false);
  const mistakeItem = ensureStage2Mistake();

  if(!mistakeItem){
    mainPanel.innerHTML = `
      <h2 style="margin:0 0 6px">ç¬¬2éšæ®µï½œå•é¡ŒæŒ–æ˜ Why It Happened?</h2>
      <div class="lockBanner">æ‰¾ä¸åˆ° Stage1 çš„${WORD_SMALL_MISTAKE}ç´€éŒ„ã€‚è«‹å›åˆ° Stage1 å®Œæˆæäº¤å¾Œå†é€²å…¥ Stage2ã€‚</div>
      <div style="height:10px"></div>
      <button class="btn" onclick="goStage('s1'); render();">â¬…ï¸ å› Stage 1</button>
    `;
    return;
  }

  mainPanel.innerHTML = `
    <h2 style="margin:0 0 6px">ç¬¬2éšæ®µï½œå•é¡ŒæŒ–æ˜ Why It Happened?</h2>
    <div class="hint">
      å›ºå®šå…©è¼ªï¼šç›®å‰ <b>ç¬¬ ${GAME.turn.stageRound} / 2 è¼ª</b>ã€‚<br/>
      æœ¬éšæ®µæ¯å›åˆå¾ã€Œæ‰€æœ‰${WORD_SMALL_MISTAKE}ã€éš¨æ©ŸæŠ½ä¸€å€‹ï¼ˆä¸é‡è¤‡ï¼‰ï¼Œç©å®¶å›ç­”ç‚ºä»€éº¼æœƒç™¼ç”Ÿï¼ˆ+1ğŸª¨ï¼‰ã€‚
    </div>
    <div class="hr"></div>

    <div class="row" style="justify-content:space-between">
      <div class="chip ok">è¼ªåˆ°ï¼š<b>${escapeHtml(p.name)}</b>ï¼ˆ${GAME.turn.playerIndex+1}/${ps.length}ï¼‰</div>
      <div class="chip warn">è¼ªæ•¸ï¼šç¬¬ <b>${GAME.turn.stageRound}</b> è¼ª</div>
    </div>

    <div style="height:10px"></div>
    <div class="card">
      <div class="head">
        <div class="title">
          <div class="icon">ğŸ§©</div>
          <div>
            <div style="font-weight:900">æŠ½åˆ°çš„${WORD_SMALL_MISTAKE}ï¼ˆä¸é‡è¤‡ï¼‰</div>
            <div class="hint">ä¾†æºï¼š${escapeHtml(mistakeItem.fromPlayerName)}ï¼ˆStage1ï¼‰</div>
          </div>
        </div>
        <span class="pill danger">${WORD_SMALL_MISTAKE}</span>
      </div>
      <div class="body">
        <div class="bigQ">${escapeHtml(mistakeItem.text)}</div>
        <div class="sub">è«‹å›ç­”ï¼šç‚ºä»€éº¼æœƒç™¼ç”Ÿï¼Ÿï¼ˆæ ¹æœ¬åŸå› ï¼‰</div>
      </div>
    </div>

    <div style="height:10px"></div>
    <label class="hint">ç‚ºä»€éº¼æœƒç™¼ç”Ÿï¼ˆæœ€å¤š160å­—ï¼‰</label>
    <textarea id="s2Cause" maxlength="160" placeholder="ä¾‹ï¼šè³‡è¨Šæ²’å°é½Šã€å‚™æ´ä¸è¶³ã€æµç¨‹ä¸æ¸…ã€è²¬ä»»ä¸æ˜â€¦"></textarea>

    <div style="height:10px"></div>
    <div class="row" style="justify-content:space-between">
      <div class="hint">
        æˆé•·çŸ³ï¼š<b>${p.growth||0}</b>ï½œ
        <span class="kbd">èŠ± 2</span> è·³éæœ¬å›åˆï¼ˆä¸‹ä¸€ä½ï¼‰
      </div>
      <div class="row">
        <button class="btn small danger" id="btnSkip">ğŸª¨-2 è·³é</button>
        <button class="btn small primary" id="btnSubmit">æäº¤ï¼ˆ+1ğŸª¨ï¼‰</button>
      </div>
    </div>
  `;

  $("#btnSkip").onclick = ()=>{
    if(!spendGrowth(p.id, 2)) return toast("æˆé•·çŸ³ä¸è¶³ï¼ˆéœ€è¦ 2 é¡†ï¼‰");
    GAME.stage2.current = null;
    toast("å·²è·³éï¼ˆæ›ä¸‹ä¸€ä½ï¼‰");
    nextTurnOrStage();
    render();
  };

  $("#btnSubmit").onclick = ()=>{
    const cause = ($("#s2Cause").value||"").trim();
    if(!cause) return toast("è«‹è¼¸å…¥åŸå› ");

    addLog({
      playerId: p.id,
      playerName: p.name,
      kind: "s2",
      prompt: mistakeItem.text,
      fields: {
        smallMistakePrompt: mistakeItem.text,
        smallMistakeFrom: mistakeItem.fromPlayerName,
        smallMistakeSourceLogId: mistakeItem.sourceLogId,
        cause
      },
      reacts: {}
    });

    addGrowth(p.id, 1);
    toast("å·²æäº¤ï¼š+1 æˆé•·çŸ³");

    GAME.stage2.current = null;
    nextTurnOrStage();

    if(GAME.stage==="s3") initStage3UsageIfNeeded(true);

    render();
  };
}

/** Stage2: Pig card UI **/
function renderPigCardStage2(){
  const ps = getPlayers();
  const p = currentPlayer();
  if(!p) return;

  mainPanel.innerHTML = `
    <h2 style="margin:0 0 6px">${escapeHtml(PIG_TITLE_LINE)}</h2>
    <div class="hint">
      æœ¬è¼ªé™å®šäº‹ä»¶ï¼šè«‹å¡«å…¥ã€Œä¸€å€‹éŒ¯ã€èˆ‡ã€Œå¦‚ä½•é¿å…ã€ã€‚å„²å­˜å¾Œä½ æœƒå¾—åˆ° <b>+3</b> é¡†æˆé•·çŸ³ã€‚<br/>
      ï¼ˆåŒä¸€è¼ª Stage2 æœ€å¤šå‡ºç¾ä¸€æ¬¡ï¼Œå„²å­˜å¾Œå›åˆ°åŸæœ¬æµç¨‹ï¼‰
    </div>
    <div class="hr"></div>

    <div class="row" style="justify-content:space-between">
      <div class="chip ok">è¼ªåˆ°ï¼š<b>${escapeHtml(p.name)}</b>ï¼ˆ${GAME.turn.playerIndex+1}/${ps.length}ï¼‰</div>
      <div class="chip warn">è¼ªæ•¸ï¼šç¬¬ <b>${GAME.turn.stageRound}</b> è¼ª</div>
    </div>

    <div style="height:10px"></div>
    <div class="card">
      <div class="head">
        <div class="title">
          <div class="icon">ğŸ½</div>
          <div>
            <div style="font-weight:900">${escapeHtml(PIG_TITLE_LINE)}</div>
            <div class="hint">è¦é»æ“Šã€Œè€¶ï¼ç¹¼çºŒã€æ‰èƒ½å›åˆ°å‰›å‰›æµç¨‹</div>
          </div>
        </div>
        <span class="pill danger">è±¬éšŠå‹å¡</span>
      </div>
      <div class="body">
        <div class="two">
          <div>
            <label class="hint">çŠ¯çš„ä¸€å€‹éŒ¯ï¼ˆè‡ªå·±æˆ–ä»–äººï¼‰</label>
            <textarea id="pigMistake" maxlength="140" placeholder="ä¾‹ï¼šå¿˜è¨˜é€šçŸ¥æŸçµ„ã€è‡¨æ™‚æ”¹æµç¨‹æ²’åŒæ­¥â€¦"></textarea>
          </div>
          <div>
            <label class="hint">è©²å¦‚ä½•é¿å…</label>
            <textarea id="pigAvoid" maxlength="140" placeholder="ä¾‹ï¼šå»ºç«‹é€šçŸ¥æ¸…å–®ã€é›™äººç¢ºèªã€å›ºå®šæµç¨‹ç‰ˆæœ¬â€¦"></textarea>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="row" style="justify-content:flex-end">
          <button class="btn primary" id="btnPigSave">ğŸ’¾ å„²å­˜ï¼ˆ+3ğŸª¨ï¼‰ğŸ‘‰ è€¶ï¼ç¹¼çºŒ</button>
        </div>
      </div>
    </div>
  `;

  $("#btnPigSave").onclick = ()=>{
    const pigMistake = ($("#pigMistake").value||"").trim();
    const pigAvoid   = ($("#pigAvoid").value||"").trim();
    if(!pigMistake || !pigAvoid) return toast("å…©æ ¼éƒ½è¦å¡«");

    // è¨˜éŒ„ log
    addLog({
      playerId: p.id,
      playerName: p.name,
      kind: "pig",
      prompt: PIG_TITLE_LINE,
      fields: { pigMistake, pigAvoid },
      reacts: {}
    });

    // +3 æˆé•·çŸ³
    addGrowth(p.id, 3);

    // åŒä¸€è¼ªæœ€å¤šä¸€æ¬¡ â†’ æ¨™è¨˜ used
    GAME.stage2.pig.usedInRound = GAME.stage2.pig.usedInRound || {};
    GAME.stage2.pig.usedInRound[GAME.turn.stageRound] = true;

    // é—œæ‰è±¬å¡ï¼Œå›åˆ° Stage2 åŸæµç¨‹ï¼ˆåŒä¸€ä½ç©å®¶ç¹¼çºŒæŠ½å°å¤±èª¤ï¼‰
    GAME.stage2.pig.active = false;

    toast("ğŸ½ å·²å„²å­˜ï¼š+3 æˆé•·çŸ³ï¼ˆå›åˆ°å‰›å‰›æµç¨‹ï¼‰");
    render();
  };
}

/** =========================
 *  Stage 3
 *  ========================= */
function renderStage3(){
  const ps = getPlayers();
  const p = currentPlayer();
  if(!p){ goStage("lobby"); return render(); }

  initStage3UsageIfNeeded(false);
  const causeItem = ensureStage3Cause();
  if(!causeItem){
    mainPanel.innerHTML = `
      <h2 style="margin:0 0 6px">ç¬¬3éšæ®µï½œé»å­ç”Ÿæˆ What Can We Do Better?</h2>
      <div class="lockBanner">æ‰¾ä¸åˆ° Stage2 çš„åŸå› ç´€éŒ„ã€‚è«‹å…ˆå®Œæˆ Stage2 çš„æäº¤ã€‚</div>
      <div style="height:10px"></div>
      <button class="btn" onclick="goStage('s2'); render();">â¬…ï¸ å› Stage 2</button>
    `;
    return;
  }

  const usedCount = (GAME.stage3.usage?.[causeItem.sourceLogId] || 0);
  const cap = GAME.stage3.capPerCause || 2;

  mainPanel.innerHTML = `
    <h2 style="margin:0 0 6px">ç¬¬3éšæ®µï½œé»å­ç”Ÿæˆ What Can We Do Better?</h2>
    <div class="hint">
      å›ºå®šå…©è¼ªï¼šç›®å‰ <b>ç¬¬ ${GAME.turn.stageRound} / 2 è¼ª</b>ã€‚<br/>
      æœ¬éšæ®µæ¯å›åˆå¾ã€Œæ‰€æœ‰åŸå› ã€éš¨æ©ŸæŠ½ä¸€å€‹ï¼ˆåŒä¸€åŸå› æœ€å¤šå‡ºç¾ 2 æ¬¡ï¼‰ï¼Œç©å®¶æå‡ºé»å­ï¼ˆ+1ğŸª¨ï¼‰ã€‚
    </div>
    <div class="hr"></div>

    <div class="row" style="justify-content:space-between">
      <div class="chip ok">è¼ªåˆ°ï¼š<b>${escapeHtml(p.name)}</b>ï¼ˆ${GAME.turn.playerIndex+1}/${ps.length}ï¼‰</div>
      <div class="chip warn">è¼ªæ•¸ï¼šç¬¬ <b>${GAME.turn.stageRound}</b> è¼ª</div>
    </div>

    <div style="height:10px"></div>
    <div class="card">
      <div class="head">
        <div class="title">
          <div class="icon">ğŸ”</div>
          <div>
            <div style="font-weight:900">æŠ½åˆ°çš„åŸå› ï¼ˆæœ€å¤š 2 æ¬¡ï¼‰</div>
            <div class="hint">ç›®å‰æ­¤åŸå› å·²å‡ºç¾ï¼š<b>${usedCount}</b> / ${cap}</div>
          </div>
        </div>
        <span class="pill warn">Cause</span>
      </div>
      <div class="body">
        <div class="bigQ">${escapeHtml(causeItem.text)}</div>
        <div class="sub">è«‹æå‡ºä¸€å€‹ä½ å€‘å¯ä»¥åšå¾—æ›´å¥½çš„é»å­ï¼ˆå¯è½åœ°ï¼‰</div>
      </div>
    </div>

    <div style="height:10px"></div>
    <label class="hint">ä½ çš„é»å­ï¼ˆæœ€å¤š180å­—ï¼‰</label>
    <textarea id="s3Idea" maxlength="180" placeholder="ä¾‹ï¼šå»ºç«‹æª¢æ ¸è¡¨ã€é›™äººç¢ºèªã€é æ¼”æµç¨‹ã€å›ºå®šè¨Šæ¯æ¨¡æ¿â€¦"></textarea>

    <div style="height:10px"></div>
    <div class="row" style="justify-content:space-between">
      <div class="hint">
        æˆé•·çŸ³ï¼š<b>${p.growth||0}</b>ï½œ
        <span class="kbd">èŠ± 2</span> è·³éæœ¬å›åˆï¼ˆä¸‹ä¸€ä½ï¼‰
      </div>
      <div class="row">
        <button class="btn small danger" id="btnSkip">ğŸª¨-2 è·³é</button>
        <button class="btn small primary" id="btnSubmit">æäº¤ï¼ˆ+1ğŸª¨ï¼‰</button>
      </div>
    </div>
  `;

  $("#btnSkip").onclick = ()=>{
    if(!spendGrowth(p.id, 2)) return toast("æˆé•·çŸ³ä¸è¶³ï¼ˆéœ€è¦ 2 é¡†ï¼‰");
    GAME.stage3.current = null;
    toast("å·²è·³éï¼ˆæ›ä¸‹ä¸€ä½ï¼‰");
    nextTurnOrStage();
    render();
  };

  $("#btnSubmit").onclick = ()=>{
    const idea = ($("#s3Idea").value||"").trim();
    if(!idea) return toast("è«‹è¼¸å…¥é»å­");

    addLog({
      playerId: p.id,
      playerName: p.name,
      kind: "s3",
      prompt: causeItem.text,
      fields: {
        causePrompt: causeItem.text,
        causeSourceLogId: causeItem.sourceLogId,
        idea
      },
      reacts: {}
    });

    addGrowth(p.id, 1);
    toast("å·²æäº¤ï¼š+1 æˆé•·çŸ³");

    GAME.stage3.current = null;
    nextTurnOrStage();

    if(GAME.stage==="vote") initVoteIfNeeded(true);

    render();
  };
}

/** =========================
 *  Vote
 *  ========================= */
function renderVote(){
  const ps = getPlayers();
  const p = currentPlayer();
  if(!p){ goStage("lobby"); return render(); }

  initVoteIfNeeded(false);

  const ideas = getStage3Ideas();
  if(ideas.length===0){
    mainPanel.innerHTML = `
      <h2 style="margin:0 0 6px">ğŸª™ æŠ•ç¥¨ï½œè³‡æºå¹£ TOP5</h2>
      <div class="lockBanner">æ‰¾ä¸åˆ° Stage3 çš„é»å­ã€‚è«‹å…ˆå®Œæˆ Stage3 æäº¤ã€‚</div>
      <div style="height:10px"></div>
      <button class="btn" onclick="goStage('s3'); render();">â¬…ï¸ å› Stage 3</button>
    `;
    return;
  }

  const doneSet = new Set(GAME.vote.donePlayerIds||[]);
  const remaining = voteRemainingCoins(p.id);

  const rows = ideas.map(it=>{
    const mine = GAME.vote.allocations?.[it.ideaId]?.byPlayer?.[p.id] || 0;
    const total = GAME.vote.allocations?.[it.ideaId]?.total || 0;
    return `
      <div class="voteGrid">
        <div>
          <div style="font-weight:900">${escapeHtml(it.text)}</div>
          <div class="hint">åŸå› ï¼š${escapeHtml(it.causeText || "ï¼ˆæœªè¨˜éŒ„ï¼‰")}</div>
          <div class="hint">æå‡ºè€…ï¼š${escapeHtml(it.fromPlayerName)}ï½œç¸½ç¥¨ï¼š<b>${total}</b>ï½œä½ æŠ•ï¼š<b>${mine}</b></div>
        </div>
        <button class="btn tiny" data-idea="${it.ideaId}" data-act="minus">-1</button>
        <button class="btn tiny primary" data-idea="${it.ideaId}" data-act="plus">+1</button>
      </div>
    `;
  }).join("");

  mainPanel.innerHTML = `
    <h2 style="margin:0 0 6px">ğŸª™ æŠ•ç¥¨ï½œè³‡æºå¹£ TOP5</h2>
    <div class="hint">æ¯äºº 7 æšè³‡æºå¹£ã€‚ç¾åœ¨è¼ªåˆ° <b>${escapeHtml(p.name)}</b> æŠ•ç¥¨ï¼ˆå¯åŠ å¯æ¸›ï¼‰ã€‚</div>
    <div class="hr"></div>

    <div class="row" style="justify-content:space-between">
      <div class="chip ok">æŠ•ç¥¨è€…ï¼š<b>${escapeHtml(p.name)}</b>ï¼ˆ${GAME.turn.playerIndex+1}/${ps.length}ï¼‰</div>
      <div class="row">
        <span class="chip warn">å‰©é¤˜å¹£ï¼š<b>${remaining}</b> / 7</span>
        <span class="chip ${doneSet.has(p.id) ? "ok" : "danger"}">${doneSet.has(p.id) ? "å·²é–å®š" : "æœªé–å®š"}</span>
      </div>
    </div>

    <div style="height:10px"></div>
    <div class="lockBanner">
      è¦å‰‡ï¼šä½ å¯ä»¥æŠŠ 7 æšåˆ†æ•£æŠ•çµ¦å¤šå€‹é»å­ã€‚<br/>
      ç•¶ä½ æŒ‰ã€Œé–å®šæˆ‘çš„æŠ•ç¥¨ã€å¾Œï¼Œæœ¬äººæŠ•ç¥¨å°±å®Œæˆï¼Œæ›ä¸‹ä¸€ä½ã€‚
    </div>

    <div style="height:10px"></div>
    <div style="display:flex; flex-direction:column; gap:10px">
      ${rows}
    </div>

    <div style="height:12px"></div>
    <div class="row" style="justify-content:flex-end">
      <button class="btn danger" id="btnClearMine">æ¸…ç©ºæˆ‘çš„æŠ•ç¥¨</button>
      <button class="btn primary" id="btnLock">é–å®šæˆ‘çš„æŠ•ç¥¨ âœ ä¸‹ä¸€ä½</button>
    </div>

    <div style="height:12px"></div>
    <div class="hr"></div>
    <div class="row" style="justify-content:space-between">
      <div class="hint">å…¨éƒ¨å®Œæˆå¾Œæœƒé¡¯ç¤º TOP5ï¼Œä¸¦é€²å…¥è¡Œå‹•å¥‘ç´„ã€‚</div>
      <button class="btn" id="btnShowTop5">ğŸ‘€ å…ˆçœ‹ç›®å‰ TOP5</button>
    </div>
    <div id="top5Box" style="margin-top:10px"></div>
  `;

  mainPanel.querySelectorAll("button[data-idea]").forEach(btn=>{
    btn.onclick = ()=>{
      const ideaId = btn.dataset.idea;
      const act = btn.dataset.act;
      const doneSet2 = new Set(GAME.vote.donePlayerIds||[]);
      if(doneSet2.has(p.id)) return toast("ä½ å·²é–å®šæŠ•ç¥¨ï¼ˆè¦ä¿®æ”¹è«‹å…ˆæ¸…ç©ºå†é–å®šï¼‰");

      const rem = voteRemainingCoins(p.id);
      if(act==="plus"){
        if(rem<=0) return toast("æ²’æœ‰å‰©é¤˜è³‡æºå¹£äº†");
        voteAdd(ideaId, p.id, +1);
      }else{
        voteAdd(ideaId, p.id, -1);
      }
      render();
    };
  });

  $("#btnClearMine").onclick = ()=>{
    const doneSet2 = new Set(GAME.vote.donePlayerIds||[]);
    if(doneSet2.has(p.id) && !confirm("ä½ å·²é–å®šæŠ•ç¥¨ï¼Œç¢ºå®šè¦æ¸…ç©ºé‡æŠ•å—ï¼Ÿï¼ˆæœƒè§£é™¤é–å®šï¼‰")) return;

    GAME.vote.donePlayerIds = (GAME.vote.donePlayerIds||[]).filter(x=>x!==p.id);

    const alloc = GAME.vote.allocations || {};
    Object.keys(alloc).forEach(ideaId=>{
      if(alloc[ideaId]?.byPlayer?.[p.id]){
        alloc[ideaId].byPlayer[p.id] = 0;
        alloc[ideaId].total = Object.values(alloc[ideaId].byPlayer).reduce((s,n)=>s+n,0);
      }
    });
    toast("å·²æ¸…ç©ºä½ çš„æŠ•ç¥¨");
    render();
  };

  $("#btnLock").onclick = ()=>{
    if(voteRemainingCoins(p.id) !== 0){
      if(!confirm("ä½ é‚„æœ‰å‰©é¤˜è³‡æºå¹£ï¼Œä»è¦é–å®šå—ï¼Ÿ")) return;
    }
    const done = new Set(GAME.vote.donePlayerIds||[]);
    done.add(p.id);
    GAME.vote.donePlayerIds = Array.from(done);
    toast("å·²é–å®šä½ çš„æŠ•ç¥¨");

    if(GAME.turn.playerIndex < ps.length-1){
      GAME.turn.playerIndex += 1;
      render();
    }else{
      if(!allVoteDone()){
        GAME.turn.playerIndex = 0;
        toast("ä»æœ‰äººæœªé–å®šæŠ•ç¥¨ï¼Œå›åˆ°ç¬¬ä¸€ä½");
        render();
      }else{
        const top5 = computeTop5();
        const msg = top5.map((x,i)=>`${i+1}. åŸå› ï¼š${x.causeText}ï½œé»å­ï¼š${x.text}ï¼ˆ${x.total}ç¥¨ï¼‰`).join("\n");
        alert("âœ… æŠ•ç¥¨å®Œæˆï¼TOP5ï¼š\n\n" + msg);
        goNextStage(); // to s4
        render();
      }
    }
  };

  $("#btnShowTop5").onclick = ()=>{
    const top5 = computeTop5();
    $("#top5Box").innerHTML = `
      <div class="lockBanner">
        ç›®å‰ TOP5ï¼ˆå³æ™‚ï¼‰ï¼š<br/>
        ${top5.map((x,i)=> `${i+1}. åŸå› ï¼š${escapeHtml(x.causeText)}ï½œé»å­ï¼š${escapeHtml(x.text)}ï¼ˆ${x.total}ç¥¨ï¼‰`).join("<br/>")}
      </div>
    `;
  };
}

/** =========================
 *  Stage 4 (Contracts)
 *  ========================= */
function renderStage4(){
  const ps = getPlayers();
  const p = currentPlayer();
  if(!p){ goStage("lobby"); return render(); }

  const top5 = computeTop5();
  if(top5.length===0){
    mainPanel.innerHTML = `
      <h2 style="margin:0 0 6px">ç¬¬4éšæ®µï½œè¡Œå‹•å¥‘ç´„</h2>
      <div class="lockBanner">æ‰¾ä¸åˆ° TOP5ï¼ˆå¯èƒ½å°šæœªå®ŒæˆæŠ•ç¥¨ï¼‰ã€‚è«‹å…ˆå®ŒæˆæŠ•ç¥¨ã€‚</div>
      <div style="height:10px"></div>
      <button class="btn" onclick="goStage('vote'); render();">â¬…ï¸ å›æŠ•ç¥¨</button>
    `;
    return;
  }

  const existing = (GAME.stage4.contracts||[]).find(x=>x.playerId===p.id);
  const options = top5.map(x=>{
    const sel = existing?.ideaId===x.ideaId ? "selected" : "";
    const label = `åŸå› ï¼š${x.causeText}ï½œé»å­ï¼š${x.text}ï¼ˆ${x.total}ç¥¨ï¼‰`;
    return `<option value="${x.ideaId}" ${sel}>${escapeHtml(label)}</option>`;
  }).join("");

  mainPanel.innerHTML = `
    <h2 style="margin:0 0 6px">ç¬¬4éšæ®µï½œè¡Œå‹•å¥‘ç´„ What We'll Do</h2>
    <div class="hint">æ¯äººå¡«ä¸€å¼µå¥‘ç´„å¡ï¼šå¾ TOP5 é¸ä¸€å€‹ã€ŒåŸå› +é»å­ã€ï¼Œå¯«ä¸‹ä½ ã€Œæˆ‘å¯ä»¥åšä»€éº¼ã€ï¼ˆä¸éœ€è¦æœŸé™ï¼‰ã€‚</div>
    <div class="hr"></div>

    <div class="row" style="justify-content:space-between">
      <div class="chip ok">è¼ªåˆ°ï¼š<b>${escapeHtml(p.name)}</b>ï¼ˆ${GAME.turn.playerIndex+1}/${ps.length}ï¼‰</div>
      <div class="pill warn">å·²å®Œæˆï¼š${(GAME.stage4.contracts||[]).length} / ${ps.length}</div>
    </div>

    <div style="height:10px"></div>
    <div class="card">
      <div class="head">
        <div class="title"><div class="icon">ğŸ“</div><div>è¡Œå‹•å¥‘ç´„å¡</div></div>
        <span class="pill accent">TOP5 Only</span>
      </div>
      <div class="body">
        <label class="hint">é¸æ“‡ TOP5ï¼ˆåŸå›  + é»å­ï¼‰</label>
        <select class="input" id="cIdeaSelect">${options}</select>

        <div style="height:10px"></div>
        <label class="hint">æˆ‘å¯ä»¥åšä»€éº¼ï¼ˆæœ€å¤š160å­—ï¼‰</label>
        <textarea id="cCanDo" maxlength="160" placeholder="ä¾‹ï¼šæˆ‘å¯ä»¥æŠŠæ¨¡æ¿æ•´ç†æˆå¯ç”¨ç‰ˆæœ¬ä¸¦åœ¨ç¾¤çµ„å…¬å‘Š">${escapeHtml(existing?.canDo||"")}</textarea>

        <div style="height:10px"></div>
        <label class="hint">éœ€è¦å”åŠ©ï¼ˆå¯ç©ºï¼Œæœ€å¤š100å­—ï¼‰</label>
        <textarea id="cHelp" maxlength="100" placeholder="ä¾‹ï¼šéœ€è¦ç¸½å‹™å”åŠ©å€Ÿç‰©/éœ€è¦æŸçµ„æä¾›è³‡æ–™">${escapeHtml(existing?.help||"")}</textarea>

        <div style="height:12px"></div>
        <div class="row" style="justify-content:flex-end">
          <button class="btn small primary" id="btnSaveContract">ğŸ’¾ å„²å­˜ä¸¦ä¸‹ä¸€ä½</button>
        </div>
      </div>
    </div>

    <div style="height:12px"></div>
    <div class="lockBanner">
      å®Œæˆæ‰€æœ‰äººå¾Œæœƒè·³å‡ºã€Œæ­å–œçµæŸï¼æ˜¯å¦åŒ¯å‡ºCSVï¼Ÿã€ï¼ˆæŒ‰å–æ¶ˆä¹Ÿä¸æœƒæ¸…é™¤è³‡æ–™ï¼‰ã€‚
    </div>
  `;

  $("#btnSaveContract").onclick = ()=>{
    const ideaId = ($("#cIdeaSelect").value||"").trim();
    const canDo = ($("#cCanDo").value||"").trim();
    const help = ($("#cHelp").value||"").trim();
    if(!ideaId || !canDo) return toast("è«‹è‡³å°‘é¸ TOP5 ä¸¦å¡«ã€æˆ‘å¯ä»¥åšä»€éº¼ã€");

    const chosen = top5.find(x=>x.ideaId===ideaId);
    const ideaText = chosen?.text || "";
    const causeText = chosen?.causeText || "";

    const obj = { playerId:p.id, ideaId, causeText, ideaText, canDo, help, ts: Date.now() };

    const idx = (GAME.stage4.contracts||[]).findIndex(x=>x.playerId===p.id);
    if(idx>=0) GAME.stage4.contracts[idx] = obj;
    else GAME.stage4.contracts.push(obj);

    addLog({
      playerId: p.id,
      playerName: p.name,
      kind: "contract",
      prompt: `${causeText}ï½œ${ideaText}`,
      fields: {
        contractCause: causeText,
        contractIdea: ideaText,
        contractCanDo: canDo,
        contractHelp: help || "ç„¡"
      },
      reacts: {}
    });

    toast("å·²å„²å­˜å¥‘ç´„");

    if(GAME.turn.playerIndex < ps.length-1){
      GAME.turn.playerIndex += 1;
      render();
    }else{
      const doneN = (GAME.stage4.contracts||[]).length;
      if(doneN >= ps.length){
        setTimeout(()=>{
          const ok = confirm("ğŸ‰ æ­å–œå®Œæˆæœ¬å±€ï¼\n\næ˜¯å¦ç¾åœ¨åŒ¯å‡º CSVï¼Ÿ\nï¼ˆæŒ‰ã€å–æ¶ˆã€å°±å…ˆä¸åŒ¯å‡ºï¼Œè³‡æ–™ä»ä¿ç•™ï¼‰");
          if(ok) exportCSV();
          GAME.stage = "done";
          requestStageIntroIfNeeded("done");
          render();
        }, 50);
      }else{
        render();
      }
    }
  };
}

/** =========================
 *  Done
 *  ========================= */
function renderDone(){
  const ps = getPlayers();
  const top5 = computeTop5();
  const contracts = GAME.stage4.contracts || [];

  mainPanel.innerHTML = `
    <h2 style="margin:0 0 6px">âœ… æ­å–œçµæŸï½œæœ¬å±€ç¸½çµ</h2>
    <div class="hint">å¯æŒ‰å³ä¸Šè§’ã€ŒåŒ¯å‡ºCSVã€ï¼ˆUTF-16LEï¼ŒExcel ä¸äº‚ç¢¼ï¼‰ã€‚</div>
    <div class="hr"></div>

    <div class="card">
      <div class="head">
        <div class="title"><div class="icon">ğŸª™</div><div>TOP5ï¼ˆåŸå›  + é»å­ï¼‰</div></div>
      </div>
      <div class="body">
        ${top5.map((x,i)=>`
          <div style="margin:10px 0">
            <div class="row" style="justify-content:space-between">
              <div style="font-weight:900">${i+1}. é»å­ï¼š${escapeHtml(x.text)}</div>
              <span class="pill ok">${x.total} ç¥¨</span>
            </div>
            <div class="hint">åŸå› ï¼š${escapeHtml(x.causeText)}</div>
          </div>
        `).join("")}
      </div>
    </div>

    <div style="height:12px"></div>
    <div class="card">
      <div class="head">
        <div class="title"><div class="icon">ğŸ“</div><div>è¡Œå‹•å¥‘ç´„å¡</div></div>
      </div>
      <div class="body">
        ${contracts.map(c=>{
          const p = getPlayer(c.playerId);
          return `
            <div class="listItem">
              <div class="row" style="gap:10px">
                <div class="miniIcon">${escapeHtml((p?.name||"?").slice(0,1))}</div>
                <div>
                  <div style="font-weight:900">${escapeHtml(p?.name||"")}</div>
                  <div class="hint"><b>åŸå› ï¼š</b>${escapeHtml(c.causeText)}</div>
                  <div class="hint"><b>é»å­ï¼š</b>${escapeHtml(c.ideaText)}</div>
                  <div class="hint"><b>æˆ‘å¯ä»¥åšä»€éº¼ï¼š</b>${escapeHtml(c.canDo)}</div>
                  <div class="hint"><b>éœ€è¦å”åŠ©ï¼š</b>${escapeHtml(c.help||"ç„¡")}</div>
                </div>
              </div>
            </div>
          `;
        }).join("") || `<div class="hint">ï¼ˆå°šç„¡å¥‘ç´„ï¼‰</div>`}
      </div>
    </div>

    <div style="height:12px"></div>
    <div class="card">
      <div class="head">
        <div class="title"><div class="icon">ğŸª¨</div><div>æˆé•·çŸ³ç¸½è¦½</div></div>
      </div>
      <div class="body">
        ${ps.map(p=>`
          <div class="row" style="justify-content:space-between">
            <div style="font-weight:900">${escapeHtml(p.name)}</div>
            <span class="pill ok">ğŸª¨ ${p.growth||0}</span>
          </div>
        `).join("")}
      </div>
    </div>
  `;
}

/** Top buttons **/
$("#btnReset").onclick = ()=> hardReset();
$("#btnExportCSV").onclick = ()=> exportCSV();

/** Start **/
(function boot(){
  // è‹¥ä¸€é–‹å§‹å°±æƒ³åœ¨ lobby ä¹Ÿæ’­ introï¼Œå¯ä»¥æ‰“é–‹ä¸‹é¢é€™è¡Œ
  // requestStageIntroIfNeeded("lobby");
  render();
})();
</script>
</body>
</html>





